<!doctype html>
<html>

  <head>

    <meta charset="utf-8">

    <title> Jigsaw-Builder test page </title>

  </head>

  <body>

    <canvas id="canvas" onmousedown="dragStart(event)" onmouseup="dragEnd(event)" onmousemove="drag(event)" draggable=true></canvas>

  </body>

  <script>
    // Get the Canvas element
    var canvas = document.getElementById('canvas');
    // Get the context for the canvas:
    var ctx = canvas.getContext('2d');

    // get the main image example for size
    var image = new Image();
    image.src = window.location.href.replace('index.html', 'example.png');

    // set the canvas width and height
    canvas.width = image.width;
    canvas.height= image.height;

    // create the jigsaw object to hold each piece
    var jigsaw = {};

    // get the url of this window
    var url = window.location.href.replace('index.html','jigsaw/');

    // Request the properties.json file
    var request = new Request(url+'properties.json');
    fetch(request).then( function(response) {

      // return the JSON of this response
      return response.json();

    }).then( function(response) {

      // save the properties file
      var properties = response;

      // add each jigsaw piece to test they fit together correctly
      var size = 8;
      for (j=0; j<size; j++) {
        for (i=0; i<size; i++) {

          // this will hold the jigsaw piece
          var piece = new Image();

          // set the x and y coordinates
          var x = properties[''+i+j].topLeftCorner.x*canvas.width;
          var y = properties[''+i+j].topLeftCorner.y*canvas.height;

          // save this piece to the jigsaw object
          jigsaw[''+i+j] = {image: piece, position: {x:x,y:y}};

          // when the piece is loaded, we can draw it onto the canvas
          piece.onload = function(event) {
            // get the image from the event
            var image = event.target;

            // find the coordinates for this piece
            var jigsawpiece = Object.keys(jigsaw).filter(x => jigsaw[x].image == image);
            var position = jigsaw[jigsawpiece].position;

            // draw the piece onto the canvas
            ctx.drawImage(image, position.x, position.y);
          }

          // load the image
          piece.src = 'jigsaw/'+i+j+'.png';

        }
      }
    });

    // add animation
    setInterval(function() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      Object.keys(jigsaw).forEach(function(index) {
        var piece = jigsaw[index];
        ctx.drawImage(piece.image, piece.position.x, piece.position.y);
      });
    }, 100);

    // Add dragging ability
    var dragging = false;
    var moving = null;
    var difference = {
      x: 0,
      y: 0
    }
    function dragStart(event) {
      // find which piece was clicked
      Object.keys(jigsaw).forEach(function(index) {
        var piece = jigsaw[index];
        if (event.clientX - piece.position.x < piece.image.width &&
            event.clientY - piece.position.y < piece.image.height &&
            event.clientX - piece.position.x > 0 &&
            event.clientY - piece.position.y > 0
        ) {
            moving = piece;
            dragging = true;
            difference.x = piece.position.x - event.clientX;
            difference.y = piece.position.y - event.clientY;
        }
      })
    }
    function dragEnd(event) {
      dragging = false;
      moving = null;
    }
    function drag(event) {
      if (!dragging || moving == null) {
        return;
      }
      moving.position.x = event.clientX + difference.x;
      moving.position.y = event.clientY + difference.y;
    }

  </script>

</html>
